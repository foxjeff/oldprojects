<!DOCTYPE html PUBLIC "-//IETF//DTD HTML 2.0//EN">
<HTML>
<HEAD>
<TITLE>Enscript Output</TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000" LINK="#1F00FF" ALINK="#FF0000" VLINK="#9900DD">
<A NAME="top">
<A NAME="file1">
<H1>server.rb</H1>

<PRE>
<I><FONT COLOR="#B22222">#!/usr/bin/env ruby -w
</FONT></I><B><FONT COLOR="#A020F0">module</FONT></B> Simulator
	<B><FONT COLOR="#5F9EA0">require</FONT></B> <FONT COLOR="#BC8F8F"><B>'socket'</FONT></B>
	<B><FONT COLOR="#5F9EA0">require</FONT></B> <FONT COLOR="#BC8F8F"><B>'rubygems'</FONT></B>
	<B><FONT COLOR="#5F9EA0">require</FONT></B> <FONT COLOR="#BC8F8F"><B>'highline/import'</FONT></B>

	Port = 8080
	IP = <FONT COLOR="#BC8F8F"><B>'127.0.0.1'</FONT></B>

	<B><FONT COLOR="#A020F0">class</FONT></B> Acceptor

		<B><FONT COLOR="#5F9EA0">include</FONT></B> Simulator
		<B><FONT COLOR="#5F9EA0">include</FONT></B> HighLine::SystemExtensions
		<I><FONT COLOR="#B22222">#include Obserable
</FONT></I>		
		<FONT COLOR="#DA70D6"><B>attr_accessor</FONT></B> :server_thread

		<B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">accept
</FONT></B>			puts <FONT COLOR="#BC8F8F"><B>&quot;hello world, now accepting connections at ip: #{IP} on port: #{Port}&quot;</FONT></B>, <FONT COLOR="#BC8F8F"><B>&quot;it's now #{Time.now}&quot;</FONT></B>

			<B><FONT COLOR="#A020F0">begin</FONT></B>
				<FONT COLOR="#B8860B">@server_thread</FONT> = Hash.new;
				Signal.trap(<FONT COLOR="#BC8F8F"><B>&quot;INT&quot;</FONT></B>) <B><FONT COLOR="#A020F0">do</FONT></B>
						Thread.new { handle_command_input }
					<B><FONT COLOR="#A020F0">end</FONT></B>
				server = TCPServer.new(IP, Port) 
				<B><FONT COLOR="#A020F0">while</FONT></B> (session = server.accept) 
					<FONT COLOR="#B8860B">@server_thread</FONT>[session] = Thread.new { handle_session(session, <FONT COLOR="#DA70D6"><B>self</FONT></B>) } 
					puts <FONT COLOR="#BC8F8F"><B>&quot;starting new session: #{session}&quot;</FONT></B>, <FONT COLOR="#BC8F8F"><B>&quot;there are currently #{@server_thread.size} sessions&quot;</FONT></B>
				<B><FONT COLOR="#A020F0">end</FONT></B> 
			<B><FONT COLOR="#A020F0">rescue</FONT></B>
				puts <FONT COLOR="#BC8F8F"><B>&quot;Error: #{$!}&quot;</FONT></B>
			<B><FONT COLOR="#A020F0">end</FONT></B>
		<B><FONT COLOR="#A020F0">end</FONT></B>

		<B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">handle_command_input
</FONT></B>			<B><FONT COLOR="#A020F0">while</FONT></B> ( command = get_character )
				<B><FONT COLOR="#A020F0">case</FONT></B> command.chr
					<B><FONT COLOR="#A020F0">when</FONT></B> /q/
						puts <FONT COLOR="#BC8F8F"><B>&quot;going away now...&quot;</FONT></B>
						<FONT COLOR="#B8860B">@server_thread</FONT>.each {|s, thread| thread.join}
						exit(0)
					<B><FONT COLOR="#A020F0">when</FONT></B> /\?/
						puts <FONT COLOR="#BC8F8F"><B>&quot;there are currently #{@server_thread.size} sessions&quot;</FONT></B>, <FONT COLOR="#B8860B">@server_thread</FONT>.inspect
					<B><FONT COLOR="#A020F0">else</FONT></B>
						puts <FONT COLOR="#BC8F8F"><B>&quot;hello&quot;</FONT></B>
				<B><FONT COLOR="#A020F0">end</FONT></B>
			<B><FONT COLOR="#A020F0">end</FONT></B>
		<B><FONT COLOR="#A020F0">end</FONT></B>

		<B><FONT COLOR="#A020F0">def</FONT></B> <B><FONT COLOR="#0000FF">handle_session</FONT></B>(session, observer)
			<B><FONT COLOR="#A020F0">while</FONT></B> ( request = session.gets )
				session.print <FONT COLOR="#BC8F8F"><B>&quot;Request: #{request}&quot;</FONT></B> 
				session.print <FONT COLOR="#BC8F8F"><B>&quot;hello from #{self}&quot;</FONT></B>
			<B><FONT COLOR="#A020F0">end</FONT></B>
			<FONT COLOR="#B8860B">@server_thread</FONT>.reject! {|s,t| t == Thread.current}
			session.close 
			puts <FONT COLOR="#BC8F8F"><B>&quot;session dropped, there are now #{@server_thread.size} sessions&quot;</FONT></B>
			Thread.exit
		<B><FONT COLOR="#A020F0">end</FONT></B>

	<B><FONT COLOR="#A020F0">end</FONT></B>
<B><FONT COLOR="#A020F0">end</FONT></B>

a = Simulator::Acceptor.new
a.accept
</PRE>
<HR>
<ADDRESS>Generated by <A HREF="http://www.iki.fi/~mtr/genscript/">GNU enscript 1.6.1</A>.</ADDRESS>
</BODY>
</HTML>
